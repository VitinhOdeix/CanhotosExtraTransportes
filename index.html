<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extra Transportes</title>
  <style>
    body{font-family:Arial;background:#f8f9fa;margin:0;padding:20px;text-align:center}
    .c{background:#fff;max-width:420px;margin:auto;padding:30px;border-radius:25px;box-shadow:0 15px 40px rgba(0,0,0,.2);overflow:hidden}
    .logo{width:280px;margin:20px auto;display:block}
    input,button{width:90%;padding:16px;margin:12px auto;display:block;border-radius:12px;border:2px solid #007bff;font-size:18px;box-sizing:border-box}
    button{background:#007bff;color:#fff;font-weight:bold;cursor:pointer}
    button:disabled{background:#ccc;cursor:not-allowed}
    .fotos{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0}
    .foto-prev{width:100px;height:100px;object-fit:cover;border-radius:10px;border:2px solid #007bff;position:relative}
    .remover{position:absolute;top:5px;right:5px;background:red;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;line-height:20px;cursor:pointer}
    #progress-container{width:90%;height:20px;background:#ddd;border-radius:10px;margin:15px auto;overflow:hidden;display:none}
    #progress-bar{height:100%;width:0;background:#007bff;transition:width 0.3s}
    #ok{margin-top:15px;font-weight:bold;color:green}
    h2{color:#007bff}
    .camera-actions{width:90%;margin:10px auto 0;display:flex;justify-content:center;gap:10px}
    .camera-actions button{width:100%;padding:14px;font-size:16px;margin:0}
    .obs p{font-size:14px;line-height:1.5;margin:10px 0}
    .exemplo-container{width:90%;max-width:400px;margin:20px auto;border:2px dashed #007bff;border-radius:12px;overflow:hidden;background:#f0f8ff;padding:10px;box-sizing:border-box}
    .exemplo-img{width:100%;height:auto;max-height:300px;object-fit:contain;border-radius:8px;display:block;margin:0 auto}
    #loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,123,255,0.9);color:white;padding:20px;border-radius:10px;font-size:16px;z-index:9999;text-align:center}
    .spinner{border:3px solid rgba(255,255,255,0.3);border-top:3px solid white;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .hidden{display:none}
    .msg{margin:15px 0;font-weight:bold;color:#d00}
    .msg.ok{color:green}
  </style>
</head>
<body>
  <div class="c">
    <img src="logo.png" alt="Extra Transportes" class="logo" onerror="this.style.display='none'">
    <h2>Verificar Placa</h2>

    <div class="obs">
      <p>Fotos devem ser nítidas e bem iluminadas.<br>
      Fotos não legíveis serão solicitadas novamente.<br>
      O site pedirá permissões — clique em "Permitir".</p>
      <div class="exemplo-container">
        <img src="exemplo.jpg" alt="Foto de exemplo" class="exemplo-img" onerror="this.style.display='none'">
      </div>
    </div>

    <input type="text" id="placa" placeholder="Placa (ex: ABC1D23)" maxlength="7" style="text-transform:uppercase">
    <button onclick="verificarPlaca()">Verificar Acesso</button>
    <p id="msg" class="msg"></p>

    <!-- APP LIBERADO -->
    <div id="app" class="hidden">
      <h2>Comprovante Liberado!</h2>
      <input type="text" id="motorista" placeholder="Nome do Motorista" required>
      <input type="text" id="nota" placeholder="Número da Nota/CT-e" required>
      <button onclick="iniciar()">Iniciar Comprovante</button>
      <div class="fotos" id="fotos"></div>
      <div id="progress-container"><div id="progress-bar"></div></div>
      <button onclick="enviar()" id="env" style="display:none">Enviar para Transportadora</button>
      <p id="ok"></p>
    </div>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    Processando foto...
  </div>

  <script>
    // === CÓDIGO ===
    const URL = 'https://script.google.com/macros/s/AKfycbxIFoPXrDQhcgcliGEV1YUKqbBwDfSxAasilF4nwjz1t1_NwghcHMxUFe0DW5SdC0aRbw/exec';
      let tentativasConexao = 0;
      
      // 1. VERIFICAR CONEXÃO
      function verificarConexao() {
        if (!navigator.onLine) {
          throw new Error('SEM_INTERNET');
        }
      }
      
      // 2. FETCH COM TIMEOUT E RETRY
      async function fetchSeguro(url, options, maxRetries = 3, timeout = 30000) {
        verificarConexao();
        
        for (let tentativa = 0; tentativa < maxRetries; tentativa++) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            const response = await fetch(url, {
              ...options,
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
              throw new Error(`HTTP_${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType?.includes('application/json')) {
              const text = await response.text();
              console.error('Resposta não-JSON:', text);
              throw new Error('FORMATO_INVALIDO');
            }
            
            return await response.json();
            
          } catch (error) {
            const isLastAttempt = tentativa === maxRetries - 1;
            
            if (error.name === 'AbortError') {
              console.error('Timeout na tentativa', tentativa + 1);
              if (isLastAttempt) throw new Error('TIMEOUT');
            } else if (isLastAttempt) {
              throw error;
            }
            
            // Backoff exponencial: 1s, 2s, 4s
            const delay = Math.pow(2, tentativa) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // 3. ENVIAR COM TRATAMENTO COMPLETO
      async function enviar() {
        if (!placaAutorizada) {
          mostrarErro('Placa não autorizada!');
          return;
        }
        
        const envBtn = document.getElementById('env');
        envBtn.disabled = true;
        
        try {
          verificarConexao();
          
          document.getElementById('progress-container').style.display = 'block';
          document.getElementById('ok').innerHTML = "Enviando...";
          
          const nota = document.getElementById('nota').value.trim();
          const motorista = document.getElementById('motorista').value.trim();
          
          // ENVIAR SEQUENCIALMENTE (não em paralelo!)
          for (let i = 0; i < fotos.length; i++) {
            const foto = fotos[i];
            
            try {
              const b64 = await lerArquivoBase64(foto);
              
              const dados = {
                acao: "enviarFoto",
                nota: nota,
                placa: placaUsada,
                motorista: motorista,
                lat: lat,
                lng: lng,
                nome: `${nota}_${i+1}_${placaUsada}.jpg`,
                file: b64
              };
              
              const resultado = await fetchSeguro(URL, {
                method: 'POST',
                body: JSON.stringify(dados),
                headers: { 'Content-Type': 'application/json' }
              });
              
              if (resultado.status !== 'OK') {
                throw new Error(resultado.message || 'Erro no servidor');
              }
              
              // Atualizar progresso
              const progresso = ((i + 1) / fotos.length) * 100;
              document.getElementById('progress-bar').style.width = progresso + '%';
              
            } catch (erro) {
              console.error(`Erro ao enviar foto ${i + 1}:`, erro);
              throw new Error(`Falha na foto ${i + 1}: ${erro.message}`);
            }
          }
          
          // SUCESSO!
          sucesso();
          
        } catch (erro) {
          envBtn.disabled = false;
          tratarErro(erro);
        }
      }
      
      // 4. TRATAR ERROS COM MENSAGENS CLARAS
      function tratarErro(erro) {
        let mensagem = '';
        let sugestao = '';
        
        switch (erro.message) {
          case 'SEM_INTERNET':
            mensagem = '❌ Sem conexão com a internet';
            sugestao = 'Conecte-se ao WiFi ou dados móveis e tente novamente.';
            break;
            
          case 'TIMEOUT':
            mensagem = '⏱️ Tempo esgotado';
            sugestao = 'Sua conexão está muito lenta. Tente em um local com melhor sinal.';
            break;
            
          case 'FORMATO_INVALIDO':
            mensagem = '⚠️ Erro no servidor';
            sugestao = 'O servidor retornou uma resposta inválida. Contate o suporte.';
            break;
            
          default:
            if (erro.message.includes('HTTP_')) {
              const status = erro.message.split('_')[1];
              mensagem = `❌ Erro HTTP ${status}`;
              sugestao = status === '429' ? 
                'Muitas requisições. Aguarde 1 minuto e tente novamente.' :
                'Problema no servidor. Tente novamente.';
            } else {
              mensagem = '❌ Erro desconhecido';
              sugestao = erro.message;
            }
        }
        
        document.getElementById('ok').innerHTML = `
          <div style="color: #d00;">
            <strong>${mensagem}</strong><br>
            <span style="font-size: 14px;">${sugestao}</span>
          </div>
        `;
      }
      
      // 5. HELPER: LER ARQUIVO
      function lerArquivoBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      
      // 6. LISTENERS PARA CONEXÃO
      window.addEventListener('online', () => {
        console.log('✅ Internet restaurada');
        document.getElementById('ok').innerHTML = '✅ Internet restaurada!';
      });
      
      window.addEventListener('offline', () => {
        console.log('❌ Internet perdida');
        alert('⚠️ Conexão perdida! Não envie fotos até reconectar.');
      });
      
      function sucesso() {
        const total = fotos.length;
        const nota = document.getElementById('nota').value.trim();
        const motorista = document.getElementById('motorista').value.trim();
        
        document.getElementById('ok').innerHTML = "✅ Tudo enviado! Abrindo WhatsApp...";
        
        const msg = `Entrega ${nota} com ${total} foto(s)!\nMotorista: ${motorista}\nPlaca: ${placaUsada}\nLocal: https://maps.google.com/?q=${lat},${lng}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        
        setTimeout(() => location.reload(), 3000);
      }

    function mostrarErro(msg) {
      document.getElementById('ok').innerHTML = `<div style="color:#d00"><strong>${msg}</strong></div>`;
    }

    // === RESTO DO CÓDIGO (DEPOIS DO .TXT) ===
    let fotos = [], lat = null, lng = null, gpsPronto = false;
    let placaAutorizada = false, placaUsada = "";

    document.getElementById('placa').addEventListener('input', function(e) {
      let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      if (v.length > 7) v = v.slice(0,7);
      e.target.value = v;
    });

    function validarPlaca(placa) {
      return /^[A-Z]{3}\d[A-Z]\d{2}$/.test(placa) || /^[A-Z]{3}\d{4}$/.test(placa);
    }

    function formatarDataHora() {
      const d = new Date();
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    async function verificarPlaca() {
      const placa = document.getElementById('placa').value.trim();
      if (!placa || !validarPlaca(placa)) return alert("Placa inválida!");

      const msg = document.getElementById('msg');
      msg.innerHTML = "Verificando..."; msg.className = "msg";
      const btn = event.target; btn.disabled = true;

      try {
        const data = await fetchSeguro(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: "verificarPlaca", placa }),
          headers: { 'Content-Type': 'text/plain' }
        });

        btn.disabled = false;
        if (data.status === "OK") {
          placaAutorizada = true; placaUsada = placa;
          msg.innerHTML = "Placa autorizada!"; msg.className = "msg ok";
          document.getElementById('app').classList.remove('hidden');
        } else {
          msg.innerHTML = data.message || "Placa não autorizada";
        }
      } catch (erro) {
        btn.disabled = false;
        tratarErro(erro);
      }
    }

    function iniciar() {
      if (!placaAutorizada) return alert("Verifique a placa!");
      const m = document.getElementById('motorista').value.trim();
      const n = document.getElementById('nota').value.trim();
      if (!m || !n) return alert("Preencha todos os campos!");

      if (!gpsPronto) {
        navigator.geolocation.getCurrentPosition(p => {
          lat = p.coords.latitude.toFixed(6);
          lng = p.coords.longitude.toFixed(6);
          gpsPronto = true;
          tirarFoto();
        }, () => alert("Permita o GPS!"));
      } else tirarFoto();
    }

    function adicionarMarcaDagua(file, cb) {
      const r = new FileReader();
      r.onload = e => {
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          const ctx = c.getContext('2d');
          c.width = img.width; c.height = img.height;
          ctx.drawImage(img, 0, 0);
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(0, img.height - 110, img.width, 110);
          ctx.font = 'bold 35px Arial'; ctx.fillStyle = '#0f0'; ctx.textAlign = 'right';
          ctx.fillText('ENTREGUE', img.width - 20, img.height - 70);
          ctx.font = '22px Arial'; ctx.fillStyle = '#fff';
          ctx.fillText(formatarDataHora(), img.width - 20, img.height - 40);
          ctx.fillStyle = '#ff0';
          ctx.fillText(`${lat}, ${lng}`, img.width - 20, img.height - 10);
          c.toBlob(b => cb(new File([b], file.name, {type:'image/jpeg'})), 'image/jpeg', 0.9);
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(file);
    }

    function tirarFoto() {
      document.getElementById('loading').style.display = 'block';
      const i = document.createElement('input');
      i.type = 'file'; i.accept = 'image/*'; i.capture = 'environment';
      i.onchange = e => {
        const f = e.target.files[0];
        if (!f) { document.getElementById('loading').style.display = 'none'; return; }
        adicionarMarcaDagua(f, nf => {
          document.getElementById('loading').style.display = 'none';
          const d = document.createElement('div'); d.className = 'foto-prev';
          const img = document.createElement('img'); img.src = URL.createObjectURL(nf);
          img.style.width = img.style.height = '100%'; img.style.objectFit = 'cover';
          const x = document.createElement('div'); x.textContent = 'X'; x.className = 'remover';
          x.onclick = () => { fotos = fotos.filter(ff => ff !== nf); d.remove(); atualizarBotao(); };
          d.appendChild(img); d.appendChild(x);
          document.getElementById('fotos').appendChild(d);
          fotos.push(nf);
          mostrarAdicionarMais();
        });
      };
      i.click();
    }

    function mostrarAdicionarMais() {
      const ex = document.querySelector('.camera-actions');
      if (ex) ex.remove();
      const a = document.createElement('div'); a.className = 'camera-actions';
      const b = document.createElement('button'); b.textContent = 'Adicionar Mais'; b.onclick = tirarFoto;
      a.appendChild(b);
      document.getElementById('fotos').appendChild(a);
      atualizarBotao();
    }

    function atualizarBotao() {
      document.getElementById('env').style.display = fotos.length > 0 ? 'block' : 'none';
    }
  </script>
</body>
</html>
